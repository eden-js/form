<eden-select>
  <input type="hidden" class="d-none" each={ (item, i) in getSelected() } name={ props.multiple ? `${props.name}[${i}]` : props.name } value={ item.value } />
  <div class="droppdown">
    <button class="form-select text-left" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" onclick={ (e) => onShow(e) }>
      <span each={ (item, i) in getSelected() } class="mr-2 d-inline-flex align-items-center">
        <span if={ item.color } class={ `badge bg-${item.color} mr-2` }>
          &nbsp;
        </span>
        <span if={ !item.html }>
          { item.title || item.text || item.name }
        </span>
        <raw if={ item.html } data={ { html : item.html } } />
        { i < (getSelected().length - 1) ? ',' : '' }
      </span>
      <span if={ props.placeholder && !getSelected().length }>
        { props.placeholder }
      </span>
    </button>
    <div class="dropdown-menu">
      <div class="mb-2 p-2">
        <input class="form-control" placeholder="Search" onkeyup={ (e) => onSearch(e) } />
      </div>
      <button each={ (item, i) in getItems() } class={ classes({ 'dropdown-item d-flex align-items-center' : true, 'active' : item.selected }) } onclick={ (e) => onToggle(e, item) }>
        <span if={ item.color } class={ `badge bg-${item.color} mr-2` }>
          &nbsp;
        </span>
        <span if={ !item.html }>
          { item.title || item.text || item.name }
        </span>
        <raw if={ item.html } data={ { html : item.html } } />
      </button>
    </div>
  </div>
  

  <script>
    // import base
    import Base from '../js/base';

    // export default
    export default class EdenSelect extends Base {

      /**
       * on before mount
       */
      onBeforeMount(props) {
        // on before mount
        super.onBeforeMount(...arguments);

        // set initialized
        this.initialized = false;

        // set data
        this.data = props.data || [];
      }

      /**
       * on mounted
       */
      async onMounted(props) {
        // check frontend
        if (!this.eden.frontend || this.initialized) return;

        // initialized
        this.initialized = true;

        // load
        await this.load();
      }

      /**
       * on show
       */
      onShow(e) {
        // set width
        $(this.$('.dropdown-menu')).width($(this.$('.droppdown')).width());
        $(this.$('.form-control')).focus();
      }

      /**
       * on search
       */
      onSearch(e) {
        // update search
        this.update({
          search : e.target.value,
        });

        // load data
        this.load();
      }

      /**
       * toggle value
       */
      onToggle(e, item) {
        // check
        if (this.props.multiple) {
          e.preventDefault();
          e.stopPropagation();
        }

        // check selected
        item.selected = !item.selected;

        // update
        this.update();

        // on change
        if (this.props.onChange) {
          // value
          this.props.onChange(e, this.val());
        }
      }

      /**
       * get items
       */
      getItems() {
        // filter items
        return [...(this.data)].filter((item) => {
          // return search
          return !this.state.search || (item.title || item.text || item.name).toLowerCase().includes(this.state.search.toLowerCase())
        });
      }

      /**
        * get selected
        */
      getSelected() {
        // filter data
        return [...(this.data)].filter((item) => item.selected);
      }

      /**
       * loads data
       */
      async load() {
        // set data
        let data = this.props.data;

        // url
        if (this.props.url) {
          // await fetch
          const res = await fetch(`${this.props.url}?q=${this.state.search || ''}`);
          data = await res.json();
        }

        // load
        if (this.props.load) {
          // load from function
          data = await this.props.load(this.state.search || '');
        }

        // set data
        this.data = data.map((item) => {
          // check if selected
          if (((this.data || []).find((l) => l.value === item.value) || {}).selected) {
            item.selected = true;
          }

          // return item
          return item;
        });
        this.update();
      }
    
      /**
       * return value
       *
       * @return {*}
       */
      val() {
        // return value
        const value = this.getSelected().map((v) => v.value);

        // return value
        if (this.props.multiple) return value;

        // return first
        return value[0];
      }
    }
  </script>
</eden-select>
